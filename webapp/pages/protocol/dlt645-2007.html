<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="renderer" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title>DLT645-2007协议</title>
  <link rel="stylesheet" type="text/css" href="../../lib/layui/css/layui.css" />
  <style>
    body {
      padding: 20px;
      background-color: #f5f5f5;
    }

    .protocol-container {
      background-color: #fff;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .protocol-container .title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgb(240, 97, 47);
    }

    .result-box {
      margin-top: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border: 1px solid #e6e6e6;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-box pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .hex-display {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #333;
      word-break: break-all;
    }

    .frame-info {
      margin-top: 15px;
    }

    .frame-info .info-item {
      margin: 8px 0;
      padding: 8px;
      background-color: #fff;
      border-left: 3px solid rgb(240, 97, 47);
    }

    .frame-info .info-label {
      font-weight: bold;
      color: #666;
      margin-right: 10px;
    }
    
    .simulate-status {
      margin-top: 15px;
      padding: 10px;
      background-color: #e8f5e9;
      border-radius: 4px;
    }

    .simulate-status.running {
      background-color: #fff3e0;
    }

    .simulate-status.stopped {
      background-color: #ffebee;
    }
    
    /* 状态颜色样式 */
    .status-open {
      color: #67c23a !important;
      font-weight: bold;
    }
    
    .status-closed {
      color: #f56c6c !important;
      font-weight: bold;
    }
    
    .status-error {
      color: #e6a23c !important;
      font-weight: bold;
    }
    
    .status-warning {
      color: #e6a23c !important;
    }
    
    .status-card {
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      border-left: 3px solid #009688;
      transition: all 0.3s;
    }
    
    .status-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .status-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 8px;
    }
    
    .status-value {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>

<body>
  <div class="protocol-container">
    <div class="title">DLT645-2007协议解析</div>
    <form class="layui-form" lay-filter="parseForm">
      <div class="layui-form-item">
        <label class="layui-form-label">十六进制数据</label>
        <div class="layui-input-block">
          <textarea name="hexData" placeholder="请输入十六进制数据，例如：68 44 68 00 29 10 18 68 91 09 33 33 34 33 36 2C 16"
            class="layui-textarea" rows="3"></textarea>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="parseBtn">解析</button>
          <button type="reset" class="layui-btn layui-btn-primary">清空</button>
        </div>
      </div>
    </form>
    <div id="parseResult" class="result-box" style="display: none;"></div>
  </div>

  <div class="protocol-container">
    <div class="title">DLT645-2007协议构建</div>
    <form class="layui-form" lay-filter="buildForm">
      <div class="layui-form-item">
        <label class="layui-form-label">设备地址</label>
        <div class="layui-input-block">
          <input type="text" name="addr" placeholder="12位十六进制字符串，例如：001018290044" lay-verify="required"
            class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">帧类型</label>
        <div class="layui-input-block">
          <select name="frameType" lay-verify="required" lay-filter="frameType">
            <option value="">请选择</option>
            <optgroup label="读数据">
              <option value="read_energy_positive">读取正向有功总电能</option>
              <option value="read_energy_combined">读取组合有功总电能</option>
              <option value="read_energy_reverse">读取反向有功总电能</option>
              <option value="read_voltage_a">读取A相电压</option>
              <option value="read_voltage_b">读取B相电压</option>
              <option value="read_voltage_c">读取C相电压</option>
              <option value="read_current_a">读取A相电流</option>
              <option value="read_current_b">读取B相电流</option>
              <option value="read_current_c">读取C相电流</option>
              <option value="read_power_a">读取A相有功功率</option>
              <option value="read_power_total">读取总有功功率</option>
              <option value="read_frequency">读取电网频率</option>
              <option value="read_power_factor">读取总功率因数</option>
              <option value="read_comm_addr">读取通信地址</option>
            </optgroup>
            <optgroup label="写数据">
              <option value="write_data">写数据（通用）</option>
            </optgroup>
            <optgroup label="控制命令">
              <option value="control_on">合闸</option>
              <option value="control_off">跳闸</option>
            </optgroup>
            <optgroup label="旧版兼容">
              <option value="read_0010">读取正向有功电能 (0010)</option>
              <option value="read_0000">读取组合有功电能 (0000)</option>
              <option value="read_0f22">读取三相电流数据 (0F22)</option>
              <option value="turn_on">合闸（旧版）</option>
              <option value="turn_off">跳闸（旧版）</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div class="layui-form-item" id="writeDataFields" style="display: none;">
        <label class="layui-form-label">数据标识</label>
        <div class="layui-input-block">
          <input type="text" name="dataId" placeholder="4字节十六进制，例如：00010000" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item" id="writeDataContent" style="display: none;">
        <label class="layui-form-label">写入数据</label>
        <div class="layui-input-block">
          <input type="text" name="writeData" placeholder="十六进制数据，例如：1234" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="buildBtn">构建</button>
          <button type="reset" class="layui-btn layui-btn-primary">清空</button>
        </div>
      </div>
    </form>
    <div id="buildResult" class="result-box" style="display: none;"></div>
  </div>

  <div class="protocol-container">
    <div class="title">DLT645-2007协议设备模拟</div>
    <form class="layui-form" lay-filter="simulateForm">
      <div class="layui-form-item">
        <label class="layui-form-label">连接类型</label>
        <div class="layui-input-block">
          <select name="connType" lay-verify="required" lay-filter="connType">
            <option value="">请选择</option>
            <option value="serial">串口 (Serial)</option>
            <option value="tcp_server">TCP服务器 (TCP Server)</option>
            <option value="tcp_client">TCP客户端 (TCP Client)</option>
          </select>
        </div>
      </div>
      <!-- 串口配置 -->
      <div class="layui-form-item" id="serialConfig" style="display: none;">
        <label class="layui-form-label">串口设备</label>
        <div class="layui-input-block">
          <input type="text" name="serialPort" placeholder="例如：COM1 或 /dev/ttyUSB0" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item" id="baudRateConfig" style="display: none;">
        <label class="layui-form-label">波特率</label>
        <div class="layui-input-block">
          <input type="number" name="baudRate" value="2400" min="1200" class="layui-input" />
        </div>
      </div>
      <!-- TCP配置 -->
      <div class="layui-form-item" id="tcpConfig" style="display: none;">
        <label class="layui-form-label">TCP地址</label>
        <div class="layui-input-block">
          <input type="text" name="tcpAddress" placeholder="例如：0.0.0.0:8080 或 192.168.1.100:8080" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item" id="reconnectConfig" style="display: none;">
        <label class="layui-form-label">自动重连</label>
        <div class="layui-input-block">
          <input type="checkbox" name="reconnect" lay-skin="switch" lay-text="开启|关闭" />
          <div class="layui-form-mid layui-word-aux">TCP客户端断开后自动重连</div>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">设备地址</label>
        <div class="layui-input-block">
          <input type="text" name="addr" placeholder="12位十六进制字符串，例如：001018290044" lay-verify="required"
            class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">电能数据</label>
        <div class="layui-input-block">
          <input type="number" name="meterData" placeholder="kWh，例如：12345.67" step="0.01" class="layui-input" />
          <div class="layui-form-mid layui-word-aux">电能表读数，单位 kWh</div>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">A相电流</label>
        <div class="layui-input-block">
          <input type="number" name="ia" placeholder="A，例如：10.5" step="0.01" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">B相电流</label>
        <div class="layui-input-block">
          <input type="number" name="ib" placeholder="A，例如：10.3" step="0.01" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">C相电流</label>
        <div class="layui-input-block">
          <input type="number" name="ic" placeholder="A，例如：10.8" step="0.01" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="simulateBtn">启动设备</button>
          <button type="button" class="layui-btn layui-btn-danger" id="stopSimulateBtn" style="display: none;">停止设备</button>
        </div>
      </div>
    </form>
    <div id="simulateStatus" class="simulate-status stopped" style="display: none;">
      <div><strong>状态：</strong><span id="statusText">未运行</span></div>
      <div style="margin-top: 5px;"><strong>设备ID：</strong><span id="taskId">-</span></div>
    </div>
    
    <!-- 设备状态显示 -->
    <div id="deviceStatusPanel" style="display: none; margin-top: 20px;">
      <fieldset class="layui-elem-field layui-field-title">
        <legend>设备实时状态</legend>
      </fieldset>
      <div class="layui-row layui-col-space10">
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">电能数据</div>
            <div class="status-value" id="meterData">0.00 kWh</div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">A相电流</div>
            <div class="status-value" id="ia">0.00 A</div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">B相电流</div>
            <div class="status-value" id="ib">0.00 A</div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">C相电流</div>
            <div class="status-value" id="ic">0.00 A</div>
          </div>
        </div>
      </div>
      <div class="layui-row layui-col-space10" style="margin-top: 10px;">
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">继电器状态</div>
            <div class="status-value status-relay" id="relayStatus">合闸</div>
          </div>
        </div>
      </div>
      
      <!-- 统计信息 -->
      <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>通信统计</legend>
      </fieldset>
      <div class="layui-row layui-col-space10">
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">接收请求</div>
            <div class="status-value" id="statsRequestCount">0</div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">发送应答</div>
            <div class="status-value" id="statsResponseCount">0</div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">错误次数</div>
            <div class="status-value" id="statsErrorCount">0</div>
          </div>
        </div>
        <div class="layui-col-md3">
          <div class="status-card">
            <div class="status-label">运行时间</div>
            <div class="status-value" id="statsUptime">0s</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 指令和事件日志 -->
    <div id="deviceEventsPanel" style="display: none; margin-top: 20px;">
      <fieldset class="layui-elem-field">
        <legend>指令和事件日志</legend>
        <div class="layui-field-box">
          <div id="eventsLog" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; padding: 10px; background: #f5f5f5; border: 1px solid #ddd;">
            <div style="color: #999;">等待设备事件...</div>
          </div>
        </div>
      </fieldset>
    </div>
    
    <div id="simulateResult" class="result-box" style="display: none; max-height: 300px;"></div>
  </div>

  <script src="../../lib/layui/layui.js"></script>
  <script>
    layui.use(['form', 'layer', 'jquery'], function () {
      var form = layui.form;
      var layer = layui.layer;
      var $ = layui.jquery;

      var currentTaskId = null;
      var eventSource = null;

      // 监听连接类型变化
      form.on('select(connType)', function (data) {
        updateConnTypeFields(data.value);
      });

      // 监听帧类型变化
      form.on('select(frameType)', function (data) {
        if (data.value === 'write_data') {
          $('#writeDataFields').show();
          $('#writeDataContent').show();
        } else {
          $('#writeDataFields').hide();
          $('#writeDataContent').hide();
        }
      });

      // 更新连接类型相关字段
      function updateConnTypeFields(connType) {
        if (connType === 'serial') {
          $('#serialConfig').show();
          $('#baudRateConfig').show();
          $('#tcpConfig').hide();
          $('#reconnectConfig').hide();
        } else if (connType === 'tcp_server') {
          $('#serialConfig').hide();
          $('#baudRateConfig').hide();
          $('#tcpConfig').show();
          $('#reconnectConfig').hide();
        } else if (connType === 'tcp_client') {
          $('#serialConfig').hide();
          $('#baudRateConfig').hide();
          $('#tcpConfig').show();
          $('#reconnectConfig').show();
        } else {
          $('#serialConfig').hide();
          $('#baudRateConfig').hide();
          $('#tcpConfig').hide();
          $('#reconnectConfig').hide();
        }
        form.render();
      }

      // 解析表单提交
      form.on('submit(parseBtn)', function (data) {
        var loadIndex = layer.load(1, { shade: [0.1, '#fff'] });

        $.ajax({
          url: '/api/dlt645-2007/parse',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data.field),
          success: function (res) {
            layer.close(loadIndex);
            if (res.success) {
              displayParseResult(res);
            } else {
              layer.msg(res.message || '解析失败', { icon: 2 });
            }
          },
          error: function (xhr) {
            layer.close(loadIndex);
            var msg = '网络错误';
            if (xhr.responseJSON && xhr.responseJSON.message) {
              msg = xhr.responseJSON.message;
            }
            layer.msg(msg, { icon: 2 });
          }
        });

        return false;
      });

      // 构建表单提交
      form.on('submit(buildBtn)', function (data) {
        var field = data.field;
        var buildData = {
          addr: field.addr,
          frameType: field.frameType
        };

        var loadIndex = layer.load(1, { shade: [0.1, '#fff'] });

        $.ajax({
          url: '/api/dlt645-2007/build',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(buildData),
          success: function (res) {
            layer.close(loadIndex);
            if (res.success) {
              displayBuildResult(res);
            } else {
              layer.msg(res.message || '构建失败', { icon: 2 });
            }
          },
          error: function (xhr) {
            layer.close(loadIndex);
            var msg = '网络错误';
            if (xhr.responseJSON && xhr.responseJSON.message) {
              msg = xhr.responseJSON.message;
            }
            layer.msg(msg, { icon: 2 });
          }
        });

        return false;
      });

      // 模拟表单提交
      form.on('submit(simulateBtn)', function (data) {
        var field = data.field;
        
        if (!field.connType) {
          layer.msg('请选择连接类型', { icon: 2 });
          return false;
        }

        var simulateData = {
          connType: field.connType,
          addr: field.addr,
          meterData: parseFloat(field.meterData) || 0,
          ia: parseFloat(field.ia) || 0,
          ib: parseFloat(field.ib) || 0,
          ic: parseFloat(field.ic) || 0
        };

        // 根据连接类型添加配置
        if (field.connType === 'serial') {
          if (!field.serialPort) {
            layer.msg('请输入串口设备', { icon: 2 });
            return false;
          }
          simulateData.serialPort = field.serialPort;
          simulateData.baudRate = parseInt(field.baudRate) || 2400;
        } else if (field.connType === 'tcp_server' || field.connType === 'tcp_client') {
          if (!field.tcpAddress) {
            layer.msg('请输入TCP地址', { icon: 2 });
            return false;
          }
          simulateData.tcpAddress = field.tcpAddress;
          if (field.connType === 'tcp_client') {
            simulateData.reconnect = field.reconnect === 'on';
          }
        }

        var loadIndex = layer.load(1, { shade: [0.1, '#fff'] });

        $.ajax({
          url: '/api/dlt645-2007/simulate',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(simulateData),
          success: function (res) {
            layer.close(loadIndex);
            if (res.success) {
              currentTaskId = res.deviceId || res.taskId;
              $('#taskId').text(currentTaskId);
              $('#simulateStatus').removeClass('stopped').addClass('running').show();
              $('#statusText').text('运行中');
              $('#stopSimulateBtn').show();
              
              // 显示设备状态和事件面板
              $('#deviceStatusPanel').show();
              $('#deviceEventsPanel').show();
              
              // 初始化状态显示
              $('#meterData').text(simulateData.meterData || 0);
              $('#ia').text(simulateData.ia || 0);
              $('#ib').text(simulateData.ib || 0);
              $('#ic').text(simulateData.ic || 0);
              $('#relayStatus').text('合闸');
              
              // 连接设备事件SSE
              connectDeviceEvents(currentTaskId);
              
              layer.msg('设备已启动', { icon: 1 });
            } else {
              layer.msg(res.message || '启动失败', { icon: 2 });
            }
          },
          error: function (xhr) {
            layer.close(loadIndex);
            var msg = '网络错误';
            if (xhr.responseJSON && xhr.responseJSON.message) {
              msg = xhr.responseJSON.message;
            }
            layer.msg(msg, { icon: 2 });
          }
        });

        return false;
      });

      // 停止模拟
      $('#stopSimulateBtn').on('click', function () {
        if (!currentTaskId) {
          return;
        }

        layer.confirm('确定要停止设备吗？', { icon: 3, title: '提示' }, function (index) {
          $.ajax({
            url: '/api/dlt645-2007/simulate/' + currentTaskId + '/stop',
            type: 'POST',
            success: function (res) {
              layer.close(index);
              if (res.success) {
                // 关闭SSE连接
                if (eventSource) {
                  eventSource.close();
                  eventSource = null;
                }
                
                currentTaskId = null;
                $('#simulateStatus').removeClass('running').addClass('stopped');
                $('#statusText').text('已停止');
                $('#stopSimulateBtn').hide();
                $('#deviceStatusPanel').hide();
                $('#deviceEventsPanel').hide();
                layer.msg('设备已停止', { icon: 1 });
              } else {
                layer.msg(res.message || '停止失败', { icon: 2 });
              }
            },
            error: function () {
              layer.close(index);
              layer.msg('网络错误', { icon: 2 });
            }
          });
        });
      });

      // 连接设备事件SSE
      function connectDeviceEvents(deviceId) {
        if (eventSource) {
          eventSource.close();
        }
        
        eventSource = new EventSource('/api/dlt645-2007/events?deviceId=' + encodeURIComponent(deviceId));
        
        eventSource.onopen = function() {
          addEventLog('已连接到设备事件流', 'info');
        };
        
        eventSource.onerror = function(e) {
          console.error('SSE连接错误:', e);
          addEventLog('SSE连接错误', 'error');
        };
        
        eventSource.addEventListener('command_received', function(e) {
          try {
            var eventData = JSON.parse(e.data);
            var data = eventData.data || {};
            var commandDesc = data.commandDesc || '未知指令';
            var hexData = data.hexData || '';
            
            var message = '【收到指令】' + commandDesc;
            if (hexData) {
              message += '\n  报文: ' + formatHexData(hexData);
            }
            addEventLog(message, 'command');
          } catch (err) {
            console.error('解析事件失败:', err);
          }
        });
        
        eventSource.addEventListener('state_changed', function(e) {
          try {
            var eventData = JSON.parse(e.data);
            var data = eventData.data || {};
            var commandDesc = data.commandDesc || '';
            var changes = data.changes || {};
            var changeText = [];
            
            if (changes.meterData !== undefined) {
              changeText.push('电能: ' + changes.meterData + ' kWh');
              $('#meterData').text(changes.meterData);
            }
            if (changes.ia !== undefined) {
              changeText.push('Ia: ' + changes.ia + ' A');
              $('#ia').text(changes.ia);
            }
            if (changes.ib !== undefined) {
              changeText.push('Ib: ' + changes.ib + ' A');
              $('#ib').text(changes.ib);
            }
            if (changes.ic !== undefined) {
              changeText.push('Ic: ' + changes.ic + ' A');
              $('#ic').text(changes.ic);
            }
            if (changes.relayStatus !== undefined) {
              var relayText = changes.relayStatus ? '合闸' : '跳闸';
              changeText.push('继电器: ' + relayText);
              $('#relayStatus').text(relayText);
            }
            
            var message = '【状态变化】' + commandDesc;
            if (changeText.length > 0) {
              message += '\n  变化: ' + changeText.join(', ');
            }
            addEventLog(message, 'state');
          } catch (err) {
            console.error('解析事件失败:', err);
          }
        });
        
        eventSource.addEventListener('reply_sent', function(e) {
          try {
            var eventData = JSON.parse(e.data);
            var data = eventData.data || {};
            var hexData = data.hexData || '';
            
            var message = '【发送应答】';
            if (hexData) {
              message += '\n  报文: ' + formatHexData(hexData);
            }
            addEventLog(message, 'reply');
          } catch (err) {
            console.error('解析事件失败:', err);
          }
        });
        
        eventSource.addEventListener('connected', function(e) {
          var data = JSON.parse(e.data);
          addEventLog(data.message || '已连接', 'info');
        });
        
        // 监听状态更新事件（每3秒由后端推送）
        eventSource.addEventListener('status_update', function(e) {
          try {
            var eventData = JSON.parse(e.data);
            var data = eventData.data || {};
            var state = data.state || {};
            var statistics = data.statistics || {};
            
            // 更新设备状态显示
            if (state.meterData !== undefined) {
              $('#meterData').text(state.meterData.toFixed(2) + ' kWh');
            }
            
            if (state.ia !== undefined) {
              $('#ia').text(state.ia.toFixed(2) + ' A');
            }
            
            if (state.ib !== undefined) {
              $('#ib').text(state.ib.toFixed(2) + ' A');
            }
            
            if (state.ic !== undefined) {
              $('#ic').text(state.ic.toFixed(2) + ' A');
            }
            
            if (state.relayStatus !== undefined) {
              var relayText = state.relayStatus ? '合闸' : '分闸';
              var $relayStatus = $('#relayStatus');
              $relayStatus.text(relayText);
              $relayStatus.removeClass('status-open status-closed');
              if (state.relayStatus) {
                $relayStatus.addClass('status-open');
              } else {
                $relayStatus.addClass('status-closed');
              }
            }
            
            // 更新统计信息
            if (statistics.requestCount !== undefined) {
              $('#statsRequestCount').text(statistics.requestCount);
            }
            if (statistics.responseCount !== undefined) {
              $('#statsResponseCount').text(statistics.responseCount);
            }
            if (statistics.errorCount !== undefined) {
              $('#statsErrorCount').text(statistics.errorCount);
            }
            if (statistics.uptimeSeconds !== undefined) {
              var uptimeText = formatUptime(statistics.uptimeSeconds);
              $('#statsUptime').text(uptimeText);
            }
          } catch (err) {
            console.error('解析status_update事件失败:', err);
          }
        });
        
        function formatUptime(seconds) {
          if (seconds < 60) {
            return seconds.toFixed(0) + 's';
          } else if (seconds < 3600) {
            return (seconds / 60).toFixed(1) + 'min';
          } else {
            return (seconds / 3600).toFixed(1) + 'h';
          }
        }
      }
      
      // 格式化十六进制数据
      function formatHexData(hexStr) {
        if (!hexStr) return '';
        hexStr = hexStr.replace(/\s/g, '').toUpperCase();
        var formatted = '';
        for (var i = 0; i < hexStr.length; i += 2) {
          if (i > 0 && i % 32 === 0) {
            formatted += '\n    ';
          }
          if (i > 0) {
            formatted += ' ';
          }
          formatted += hexStr.substr(i, 2);
        }
        return formatted;
      }
      
      // 添加事件日志
      function addEventLog(message, type) {
        var logDiv = $('#eventsLog');
        var time = new Date().toLocaleTimeString();
        var color = {
          'info': '#999',
          'command': '#1890ff',
          'state': '#52c41a',
          'reply': '#722ed1',
          'error': '#ff4d4f'
        }[type] || '#333';
        
        var logEntry = $('<div style="margin-bottom: 8px; color: ' + color + '; white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.4;">[' + time + '] ' + message + '</div>');
        logDiv.append(logEntry);
        logDiv.scrollTop(logDiv[0].scrollHeight);
        
        var logs = logDiv.children();
        if (logs.length > 100) {
          logs.slice(0, logs.length - 100).remove();
        }
      }

      // 显示解析结果
      function displayParseResult(res) {
        var html = '<div class="hex-display"><strong>十六进制数据：</strong><br>' + res.hexData + '</div>';
        if (res.frame) {
          html += '<div class="frame-info">';
          html += '<div class="info-item"><span class="info-label">设备地址：</span>' + res.frame.deviceCode + '</div>';
          html += '<div class="info-item"><span class="info-label">数据类型：</span>' + res.frame.dataTypeName + '</div>';
          html += '<div class="info-item"><span class="info-label">解析状态：</span>' + (res.frame.flag ? '成功' : '失败') + '</div>';
          
          if (res.frame.dataType === 0) {
            // 读表数据
            html += '<div class="info-item"><span class="info-label">读表数据：</span>' + res.frame.data + ' kWh</div>';
          } else if (res.frame.dataType === 1) {
            // 拉合闸操作
            html += '<div class="info-item"><span class="info-label">操作结果：</span>' + (res.frame.turnResult ? '成功' : '失败') + '</div>';
          } else if (res.frame.dataType === 2) {
            // 电流数据
            html += '<div class="info-item"><span class="info-label">A相电流：</span>' + res.frame.ia + ' A</div>';
            html += '<div class="info-item"><span class="info-label">B相电流：</span>' + res.frame.ib + ' A</div>';
            html += '<div class="info-item"><span class="info-label">C相电流：</span>' + res.frame.ic + ' A</div>';
          }
          
          html += '<div class="info-item"><span class="info-label">时间戳：</span>' + res.frame.timestamp + '</div>';
          html += '</div>';
        }
        $('#parseResult').html(html).show();
      }

      // 显示构建结果
      function displayBuildResult(res) {
        var html = '<div class="hex-display"><strong>构建的十六进制数据：</strong><br>' + res.hexData + '</div>';
        if (res.frame) {
          html += '<div class="frame-info">';
          html += '<div class="info-item"><span class="info-label">设备地址：</span>' + res.frame.deviceCode + '</div>';
          html += '<div class="info-item"><span class="info-label">数据类型：</span>' + res.frame.dataTypeName + '</div>';
          html += '</div>';
        }
        $('#buildResult').html(html).show();
      }

      // SSE连接
      var eventSource = null;

      // 连接SSE接收实时推送
      function connectSSE() {
        if (eventSource) {
          return; // 已连接
        }

        eventSource = new EventSource('/sse');

        eventSource.onopen = function () {
          console.log('SSE连接已建立');
        };

        eventSource.addEventListener('connect', function (e) {
          var data = JSON.parse(e.data);
          console.log('SSE连接成功:', data);
        });

        eventSource.addEventListener('protocol', function (e) {
          var eventData = JSON.parse(e.data);
          handleProtocolEvent(eventData);
        });

        eventSource.onerror = function (e) {
          console.error('SSE连接错误:', e);
          // 尝试重连
          setTimeout(function () {
            if (eventSource && eventSource.readyState === EventSource.CLOSED) {
              eventSource = null;
              connectSSE();
            }
          }, 3000);
        };
      }

      // 处理协议事件
      function handleProtocolEvent(eventData) {
        if (eventData.topic && eventData.topic.indexOf('protocol.dlt645-2007') === 0) {
          // 显示通知
          var type = eventData.data.type;
          var message = type === 'parse' ? '解析完成' : '构建完成';
          layer.msg(message, { icon: 1, time: 1000 });
        }
      }

      // 页面加载时连接SSE
      connectSSE();
    });
  </script>
</body>

</html>
